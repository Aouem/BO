<div class="checklists-container">
  <!-- En-tÃªte avec bouton de crÃ©ation -->
  <div class="header-actions">
    <h1>Mes Checklists</h1>
    <button class="btn btn-primary" (click)="createNewChecklist()">
      + Nouvelle Checklist
    </button>
  </div>

  <!-- Barre de recherche -->
  <div class="search-container">
    <div class="search-box">
      <input 
        type="text" 
        class="form-control search-input" 
        placeholder="ğŸ” Rechercher une checklist, Ã©tape ou question..."
        [(ngModel)]="searchTerm"
        (input)="filterChecklists()"
      />
      <button 
        *ngIf="searchTerm" 
        class="btn btn-clear" 
        (click)="clearSearch()"
        title="Effacer la recherche"
      >
        âœ•
      </button>
    </div>
    <div class="search-info" *ngIf="searchTerm">
      <span class="badge">{{ filteredChecklists.length }} rÃ©sultat(s) trouvÃ©(s)</span>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des checklists...</p>
  </div>

  <!-- Liste des checklists filtrÃ©es -->
  <div *ngFor="let cl of filteredChecklists; let ci = index" class="checklist-block border p-3 mb-3 rounded">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="checklist-header">
        <h3 contenteditable="true" (blur)="onBlurLibelle($event, cl)">
          {{ cl.libelle }}
        </h3>
        <div class="checklist-stats">
          <span class="badge">{{ getTotalEtapes(cl) }} Ã©tape(s)</span>
          <span class="badge">{{ getTotalQuestions(cl) }} question(s)</span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <!-- Bouton pour voir les dÃ©tails -->
        <button class="btn btn-info btn-sm" (click)="viewChecklistDetail(cl.id!)" 
                title="Voir la checklist">
          ğŸ‘ï¸ Voir
        </button>
        <!-- Bouton pour Ã©diter -->
        <button class="btn btn-warning btn-sm" (click)="editChecklist(cl.id!)" 
                title="Modifier la checklist">
            âœï¸ Modifier
        </button>
        <button class="btn btn-success btn-sm" (click)="saveChecklist(cl)" 
                title="Sauvegarder les modifications">
            ğŸ’¾ Sauvegarder
        </button>
        <button class="btn btn-danger btn-sm" (click)="deleteChecklist(cl)" 
                title="Supprimer la checklist">
            ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    </div>

    <div *ngFor="let etape of cl.etapes; let ei = index" class="etape-block border p-2 mb-2 rounded">
      <div class="d-flex justify-content-between mb-1">
        <input type="text" class="form-control me-2" placeholder="Nom de l'Ã©tape" 
               [(ngModel)]="etape.nom" />
        <button class="btn btn-danger btn-sm" (click)="removeEtape(cl, ei)">
          Supprimer Ã©tape
        </button>
      </div>

      <div *ngFor="let q of etape.questions; let qi = index" class="question-block border p-2 mb-2 rounded">
        <input type="text" class="form-control mb-1" placeholder="Texte de la question" 
               [(ngModel)]="q.texte" />

        <select #typeSelect class="form-select mb-1" [ngModel]="q.type" 
                (ngModelChange)="updateQuestionTypeSafe(q, $event)">
          <option value="Boolean">Oui / Non</option>
          <option value="BooleanNA">Oui / Non / N/A</option>
          <option value="Texte">Texte</option>
          <option value="Liste">Liste</option>
        </select>

        <select *ngIf="q.type === 'Boolean' || q.type === 'BooleanNA'" class="form-select mb-1" 
                [(ngModel)]="q.reponse">
          <option value="">-- SÃ©lectionner --</option>
          <option *ngFor="let option of getBooleanOptions(q)" [value]="option">
            {{ option }}
          </option>
        </select>

        <div *ngIf="q.type === 'Liste'">
          <div *ngFor="let o of q.options; let oi = index" class="d-flex gap-2 mb-1">
            <input type="text" class="form-control" [(ngModel)]="o.valeur" 
                   placeholder="Valeur option" />
            <button type="button" class="btn btn-danger btn-sm" 
                    (click)="removeOption(q, oi)">Supprimer</button>
          </div>
          <button type="button" class="btn btn-secondary btn-sm" 
                  (click)="addOption(q)">Ajouter option</button>
        </div>

        <button type="button" class="btn btn-warning btn-sm mt-1" 
                (click)="removeQuestion(etape, qi)">Supprimer question</button>
      </div>

      <button type="button" class="btn btn-primary btn-sm mt-2" 
              (click)="addQuestion(etape)">Ajouter une question</button>
    </div>

    <button type="button" class="btn btn-primary btn-sm mt-2" 
            (click)="addEtape(cl)">Ajouter une Ã©tape</button>
  </div>

  <!-- Message si aucune checklist aprÃ¨s recherche -->
  <div *ngIf="!loading && filteredChecklists.length === 0" class="empty-state">
    <div *ngIf="searchTerm; else noChecklists">
      <h2>Aucun rÃ©sultat trouvÃ©</h2>
      <p>Aucune checklist ne correspond Ã  votre recherche "{{ searchTerm }}"</p>
      <button class="btn btn-secondary" (click)="clearSearch()">
        Afficher toutes les checklists
      </button>
    </div>
    <ng-template #noChecklists>
      <h2>Aucune checklist trouvÃ©e</h2>
      <p>Commencez par crÃ©er votre premiÃ¨re checklist !</p>
      <button class="btn btn-primary" (click)="createNewChecklist()">
        CrÃ©er une checklist
      </button>
    </ng-template>
  </div>
</div>